<!DOCTYPE html>
<html lang="ja">
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/ fb# website: http://ogp.me/ns/ website#">
    <title>HIC_SHI</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="icon" href="https://hic-shi.github.io/HOME/HIC_SHI_ICON.png">
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://sakazukiaoi.github.io/HIC_SHI/gallery.html" />
    <meta property="og:site_name" content="HIC_SHI" /> 
    <meta property="og:image" content="OGP_min.png" />
    <meta property="og:title" content="Gallery" /> 
    <meta property="og:description" content="" />
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="HIC_SHI_NORI">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<style>
    #headerGalley {
        color: #0d2613;
        background-color: rgb(196, 210, 196);
    }
    header button {
    color: #888888;
    }
#loader-wrapper {
    position: fixed; 
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    background-color: #333333; 
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 1;
    transition: opacity 0.5s ease-out, visibility 0.5s ease-out; 
    visibility: visible;
}

#loader-wrapper.hidden {
    opacity: 0;
    visibility: hidden;
}

#loader {
    width: 600px;
    height: 600px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    animation: spin 1.5s linear infinite; 
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
body {font-family: sans-serif;margin: 10px;background-color: #f4f4f4;color: #adadad;}
h1 {display: none;}
h2 {border-bottom: 2px solid #ffffff;padding-bottom: 5px;margin-top: 0;}
.gallery-section {margin-top:8px; margin-bottom: 1px;padding: 2px;}

.material-symbols-outlined {
font-variation-settings:
'FILL' 0,
'wght' 400,
'GRAD' 0,
'opsz' 24;
font-family: 'Material Symbols Outlined';
font-weight: normal;
font-style: normal;
font-size: 24px;
line-height: 1;
letter-spacing: normal;
text-transform: none;
display: inline-block;
white-space: nowrap;
word-wrap: normal;
direction: ltr;
-webkit-font-feature-settings: "liga";
-webkit-font-smoothing: antialiased;
}

#sortTypeToggle {
    display: flex;
    align-items: center;
    width: 70px; 
    height: 35px;
    border-radius: 17.5px; 
    background-color: #8a8a8a; 
    position: relative;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out;
    flex-shrink: 0;
    padding: 2px; 
    box-sizing: border-box; 
}

#sortTypeToggle.score-active {
    background-color: #c9c9c9; 
}

#sortTypeToggle.date-active {
    background-color: #c9c9c9; 
}

#toggleHandle {
    position: absolute;
    top: 2px; 
    left: 2px; 
    width: 31px; 
    height: 31px; 
    border-radius: 50%; 
    background-color: rgb(255, 255, 255);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
    transition: left 0.2s ease-in-out;
    z-index: 1; 
    display: flex;
    justify-content: center;
    align-items: center;
}

#sortTypeToggle.score-active #toggleHandle {
    left: 2px;
}

#sortTypeToggle.date-active #toggleHandle {
left: calc(70px - 31px - 2px);
}

.toggle-option {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 0.9em;
    pointer-events: none;
    transition: color 0.2s ease-in-out;
    z-index: 1; 
    padding: 5px;
}

#sortScore {
    left: 1px; 
    color: white; 
}

#sortDate {
    right: 1px;
    color: #a0a0a0; 
}

#sortTypeToggle.score-active #sortScore {
    color: rgb(105, 105, 105);
}
#sortTypeToggle.score-active #sortDate {
    color: #c9c9c9; 
}

#sortTypeToggle.date-active #sortScore {
    color: #c9c9c9;
    
}
#sortTypeToggle.date-active #sortDate {
    color: rgb(105, 105, 105); 
}

#galleryHeader {
display: flex;
align-items: center;
margin-bottom: 8px;
padding: 0; 
-webkit-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;

}
#galleryHeader h2 {
margin: 0;
margin-right: 15px;
border-bottom: none;
padding-bottom: 0;
}

#controlContainer {
    display: flex;
    gap: 15px; 
    align-items: center;
    flex-wrap: nowrap; 
    overflow-x: auto; 
    padding: 0px 0; 
    width: 100%; 
}

#sortGroup {
    display: flex;
    gap: 10px;
    flex-shrink: 0; 
}

#actionButtons {
    display: flex;
    gap: 10px; 
    flex-shrink: 0;
}

#sortGroup button {
    background-color: #e2e6ea;
    color: rgb(0, 0, 0); 
    border: none; 
    border-radius: 4px; 
    cursor: pointer; 
    display: flex;
    align-items: center;
    gap: 0px;
    padding: 6px 10px;
    font-size: 0.9em;
    height: 35px;
    transition: background-color 0.2s;
}
#sortGroup button:hover {
    background-color: #0091ff;
}

#actionButtons button {
    background-color: #f8f9fa;
    color: #000000; 
    border: 1px solid #ced4da; 
    border-radius: 4px; 
    cursor: pointer; 
    display: flex;
    align-items: center;
    gap: 0px;
    padding: 6px 10px;
    font-size: 0.9em;
    height: 35px;
    transition: background-color 0.2s, border-color 0.2s;
}

#resetButton {
    background-color: #dc3545;
    color: white;
    border-color: #dc3545;
}
#resetButton:hover {
    background-color: #ffffff;
    border-color: #000000;
}

.filter-active { 
    background-color: #28a745 !important;
    color: white !important;
    border-color: #28a745 !important;
}
.filter-active:hover {
    background-color: #74abff !important;
}

.filter-inverse {
    background-color: #4689d1 !important;
    color: rgb(255, 255, 255) !important;
    border-color: #778492 !important;
}
.filter-inverse:hover {
    background-color: #d6d6d6!important;
}

.sort-active {
    background-color: #e2e6ea !important;
}
.sort-active:hover {
    background-color: #b4b4b4!important;
}

.gallery-grid {
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
    grid-auto-rows: 2px;
    grid-gap: 3px; 
    padding: 0 1px;
    align-items: start;
}

@media (max-width: 900px) {
.gallery-grid {
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
}
}
@media (max-width: 600px) {
.gallery-grid {
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
    grid-auto-rows: 2px;
    grid-gap: 3px; 
    padding: 0 1px;
    align-items: start;
}
/* 横長画像用のカードに追加するクラス */
.work-card.landscape {
    grid-column: span 2; 
}
}
main{
    margin-left: 0px;
    width: 100%;
}

.work-card {
border: 1px solid #ddd;
padding: 0;
background-color: #fff;
box-shadow: 0 0 5px rgba(0,0,0,0.1);
position: relative;
overflow: hidden; 
box-sizing: border-box; 
}

.thumbnail-container { 
width: 100%; 
height: auto; 
position: relative; 
overflow: hidden; 
margin-bottom: 0; 
display: block; 
}

.thumbnail-container img.thumbnail-img { 
width: 100%; 
height: auto; 
display: block; 
}

.thumbnail-image { display: none; }
.link-overlay, .overlay-button_p, .overlay-button_x { display: none !important; }

</style>
</head>
<body>
    <header>
<a href="index.html"><button id="headerHOME">HOME</button></a>
<a href="about.html"><button id="headerAbout" >About</button></a>
<a href="links.html"><button id="headerLinks">Links</button></a>
<a href="gallery.html"><button id="headerGalley">Gallery</button></a>
    </header>    
<main>
    <div id="loader-wrapper">
    <div id="loader"></div>
</div>

<div id="notificationContainer"></div>

<div class="gallery-section">

<div id="galleryHeader">

<div id="controlContainer">
    <div id="sortGroup">
        
        <div id="sortTypeToggle" onclick="changeSortType()">
            <div id="toggleHandle"></div> <div id="sortScore" class="toggle-option">
                <span class="material-symbols-outlined">star</span>
            </div>
            <div id="sortDate" class="toggle-option">
                <span class="material-symbols-outlined">calendar_month</span>
            </div>
        </div>
        
        <button id="sortOrderButton" onclick="changeState('SORT_ORDER')">
            <span class="material-symbols-outlined">arrow_downward</span>
        </button>
    </div>
    
    <div id="actionButtons">
        <button id="resetButton" onclick="changeState('RESET')">
            <span class="material-symbols-outlined">restart_alt</span>
            <span></span>
        </button>
        <button id="originalFilterButton" onclick="changeState('FILTER')">
            <span id="filterStatusText">OC</span>
        </button>
        <a href="https://sakazukiaoi.github.io/HIC_SHI_gallery/" style="margin-top: 3px; display: flex; align-items: center;">旧式</a>
    </div>
</div>
</div>

<div class="gallery-grid" id="galleryContainer">
<p id="loadingStatus">date.jsonを読み込んでいます...</p>
</div>
</div>

<script>
let appData = { illustrations: [] };
let worksWithScore = [];

let galleryState = {
    sortType: 'score', 
    sortOrder: 'desc', 
    filterState: 0     
};

const loadingStatusElement = document.getElementById('loadingStatus');
const galleryContainerElement = document.getElementById('galleryContainer');
const sortTypeToggleElement = document.getElementById('sortTypeToggle'); 
const sortScoreButton = document.getElementById('sortScore');
const sortDateButton = document.getElementById('sortDate');
const sortOrderButton = document.getElementById('sortOrderButton');
const originalFilterButton = document.getElementById('originalFilterButton');
const filterStatusText = document.getElementById('filterStatusText');
const loaderWrapperElement = document.getElementById('loader-wrapper'); 


function getDateFromId(id) {
if (id && id.match(/^\d{8}$/)) {
const datePart = id.substring(0, 8);
return `${datePart.substring(0, 4)}-${datePart.substring(4, 6)}-${datePart.substring(6, 8)}`;
}
if (id && id.match(/^\d{10}$/)) {
const datePart = id.substring(0, 8);
return `${datePart.substring(0, 4)}-${datePart.substring(4, 6)}-${datePart.substring(6, 8)}`;
}
return getFormattedDate();
}

function normalizeWorkData(item) {
if (item.likes_history) {
item.l = item.likes_history.map(h => ({ d: h.liked_date, c: h.count }));
delete item.likes_history;
}
if (item.l) {
item.l = item.l.map(h => {
const { e, ...rest } = h;
return rest;
});
}

if (!item.s_u && item.x_u) {
item.s_u = item.x_u;
}
if (!item.tags) {
item.tags = [];
}
return item;
}

function getFormattedDate(d = new Date()) { return d.toISOString().split('T')[0]; }
function getElapsedDays(d1, d2) { return Math.max(0, Math.ceil((new Date(d2) - new Date(d1)) / (1000 * 60 * 60 * 24))); }
function getMultiplier(days) { if (days >= 365) return 4; if (days >= 181) return 3; if (days >= 91) return 2; if (days >= 31) return 1.5; return 1; }

document.addEventListener('DOMContentLoaded', async () => {
await loadDateJSON();
});

function hideLoader() {
    const imageElements = Array.from(galleryContainerElement.querySelectorAll('img.thumbnail-img'));
    const allImagesLoaded = imageElements.every(img => img.complete);
    
    if (!allImagesLoaded && imageElements.length > 0) {
        let loadedCount = 0;
        const totalImages = imageElements.length;
        
        imageElements.forEach(img => {
            if (img.complete) {
                loadedCount++;
            } else {
                img.addEventListener('load', () => {
                    loadedCount++;
                    if (loadedCount === totalImages) {
                        loaderWrapperElement.classList.add('hidden');
                    }
                }, { once: true });
                img.addEventListener('error', () => {
                    loadedCount++;
                    if (loadedCount === totalImages) {
                        loaderWrapperElement.classList.add('hidden');
                    }
                }, { once: true });
            }
        });

        if (loadedCount === totalImages) {
             loaderWrapperElement.classList.add('hidden');
        }

    } else {
        loaderWrapperElement.classList.add('hidden');
    }
}


async function loadDateJSON() {
    const statusElement = loadingStatusElement;
    if (!statusElement) return; 

    try {
     const res = await fetch('date.json');
     
     if (!res.ok) throw new Error(`HTTPエラー: ${res.status}`);
     
     let rawData = await res.json();

     if (rawData && rawData.illustrations && Array.isArray(rawData.illustrations)) {
        rawData = rawData.illustrations;
     } else if (!Array.isArray(rawData)) {
        throw new Error('JSONファイル形式が不正です。');
     }

     appData.illustrations = rawData.map(item => normalizeWorkData(item));

     calculateWorkScores();
     updateUI();
     sortGallery();

     statusElement.textContent = `date.json (${appData.illustrations.length}件の作品) を読み込みました。`;

     hideLoader();

    } catch (err) {
     console.error("JSON読み込みエラー:", err);
     statusElement.textContent = `エラー: ${err.message || 'date.jsonを読み込めませんでした。空のデータで開始します。'}`;

     appData.illustrations = [];
     worksWithScore = [];
     updateUI();
     renderGallery();
        
     hideLoader(); 
    }
}


function calculateWorkScores() {
    worksWithScore = appData.illustrations.map(w => {
     const postedDate = getDateFromId(w.id);
     
     const totalScore = (w.l || []).reduce((s, h) => {
      const days = getElapsedDays(postedDate, h.d);
      return s + (h.c * getMultiplier(days));
     }, 0);

     const totalLikes = (w.l || []).reduce((s, h) => s + h.c, 0);
     const lastLikedDate = (w.l || []).length > 0
      ? (w.l || []).map(h => h.d).sort().pop()
      : '—';

     return {
      ...w,
      totalScore: totalScore,
      totalLikes: totalLikes,
      lastLikedDate: lastLikedDate
     };
    });
}

function updateUI() {
    if (galleryState.sortType === 'score') {
        sortTypeToggleElement.classList.add('score-active');
        sortTypeToggleElement.classList.remove('date-active');
        sortScoreButton.classList.add('active');
        sortDateButton.classList.remove('active');
    } else {
        sortTypeToggleElement.classList.remove('score-active');
        sortTypeToggleElement.classList.add('date-active');
        sortScoreButton.classList.remove('active');
        sortDateButton.classList.add('active');
    }

    if (galleryState.sortOrder === 'desc') {
        sortOrderButton.innerHTML = '<span class="material-symbols-outlined">arrow_downward</span>';
        sortOrderButton.classList.add('sort-active');
    } else {
        sortOrderButton.innerHTML = '<span class="material-symbols-outlined">arrow_upward</span>';
        sortOrderButton.classList.remove('sort-active');
    }

    originalFilterButton.classList.remove('filter-active', 'filter-inverse');
    
    if (galleryState.filterState === 1) {
        originalFilterButton.classList.add('filter-active');
        filterStatusText.textContent = 'OC';
    } else if (galleryState.filterState === 2) {
        originalFilterButton.classList.add('filter-inverse');
        filterStatusText.textContent = 'OC✕';
    } else {
        filterStatusText.textContent = 'OC';
    }
}

function changeSortType() {
    const newSortType = galleryState.sortType === 'score' ? 'date' : 'score';
    
    galleryState.sortType = newSortType;
        
    updateUI();
    sortGallery();
}


function changeState(action) {
    let { sortType, sortOrder, filterState } = galleryState;
    let newState = { ...galleryState };

    if (action === 'RESET') {
     newState = { sortType: 'score', sortOrder: 'desc', filterState: 0 };
    } 
    else if (action === 'SORT_ORDER') {
     
     if (sortOrder === 'desc') {
        newState.sortOrder = 'asc';
     } else {
        newState.sortOrder = 'desc';
     }
    } 
    else if (action === 'FILTER') {
        
     if (filterState === 0) {
        newState.filterState = 1; 
     } else if (filterState === 1) {
        newState.filterState = 2; 
     } else if (filterState === 2) { 
        newState.filterState = 0; 
     }
    }

    galleryState = newState;
    
    updateUI();
    sortGallery();
}


function sortGallery() {
    const { sortType, sortOrder, filterState } = galleryState;

    let filteredWorks = worksWithScore.filter(work => {
     const hasOriginalTag = (work.tags || []).includes('オリジナル');

     if (filterState === 1) {
      return hasOriginalTag;
     } else if (filterState === 2) {
      return !hasOriginalTag;
     } else {
      return true;
     }
    });

    if (filteredWorks.length === 0) {
     renderGallery([]);
     return;
    }

    let sortedWorks = [...filteredWorks];

    sortedWorks.sort((a, b) => {
     let valA, valB;
     
     if (sortType === 'date') {
      valA = new Date(getDateFromId(a.id)).getTime();
      valB = new Date(getDateFromId(b.id)).getTime();
     } else {
      valA = a.totalScore;
      valB = b.totalScore;
     }
     
     if (sortOrder === 'desc') {
      return valB - valA;
     } else {
      return valA - valB;
     }
    });

    renderGallery(sortedWorks);
}

function renderGallery(works = []) {
    const c = galleryContainerElement;
    c.innerHTML = '';

    if (works.length === 0) {
     if (galleryState.filterState !== 0) {
      c.innerHTML = '<p>現在のフィルター条件に一致する作品はありません。</p>';
     } else {
      c.innerHTML = '<p>作品がありません。</p>';
     }
     return;
    }
    
    const rowHeight = 5; 

    works.forEach((w) => {
     const postedDate = getDateFromId(w.id);
     const cardTitle = `投稿日: ${postedDate}\nタグ: ${(w.tags || []).join(', ')}`;

     const card = document.createElement('div');
     card.className = 'work-card';
     card.title = cardTitle;

     card.innerHTML = `
     <div class="thumbnail-container">
      <img src="${w.s_u}" alt="作品" class="thumbnail-img">
     </div>
     `;
     
     card.style.gridRowEnd = `span 1`; 
     c.appendChild(card);

     const imgElement = card.querySelector('.thumbnail-img');

     const adjustCardHeight = () => {
      const naturalWidth = imgElement.naturalWidth;
      const naturalHeight = imgElement.naturalHeight;
      const aspectRatio = naturalHeight / naturalWidth;

      if (aspectRatio < 1) {
          card.classList.add('landscape');
      } else {
          card.classList.remove('landscape');
      }

      const actualCardHeight = card.clientHeight; 
      
      const requiredGridHeight = actualCardHeight + 10; 

      let spanRows = Math.ceil(requiredGridHeight / rowHeight);

      spanRows = Math.max(spanRows, 1); 
      
      card.style.gridRowEnd = `span ${spanRows}`;
     };

     imgElement.onload = adjustCardHeight;
     imgElement.onerror = () => {
      console.error(`画像のロードに失敗しました: ${w.s_u}`);
      card.style.gridRowEnd = `span 20`; 
     };

     if (imgElement.complete) {
      adjustCardHeight();
     }
    });
}
</script>
</main>
</body>
</html>
